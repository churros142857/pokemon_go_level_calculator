<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokemon Go 衝等計算機</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            max-width: 500px; 
            margin: auto; 
            box-sizing: border-box; /* 確保 padding 不會導致溢出 */
        }
        input, select { 
            width: 100%; 
            padding: 8px; 
            margin: 5px 0; 
            border: 1px solid #ccc; 
            border-radius: 4px; 
            box-sizing: border-box; 
        }
        button { 
            padding: 10px 20px; 
            margin-top: 10px; 
            cursor: pointer; 
            border: none; 
            background-color: #4CAF50; 
            color: white; 
            border-radius: 4px; 
        }
        .progress-container { 
            margin-top: 15px; 
        }
        .progress-label { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 5px; 
            font-size: 0.9em; 
            color: #555; 
            flex-wrap: wrap; /* 允許文字換行 */
            word-break: break-all; /* 長單詞可斷開 */
        }
        .progress-label span {
            flex-shrink: 1; /* 允許縮小 */
            min-width: 0; /* 確保在極端情況下可以縮小 */
            text-align: right; /* 預設右對齊 */
        }
        .progress-label span:first-child {
            text-align: left; /* 第一個 span 左對齊 */
            flex-grow: 1; /* 允許佔用更多空間 */
        }

        .progress { 
            width: 100%; 
            background: #eee; 
            border-radius: 10px; 
            margin: 5px 0; 
            overflow: hidden; 
        }
        .progress-bar { 
            height: 20px; 
            background: #4CAF50; 
            width: 0%; 
            border-radius: 10px; 
            transition: width 0.5s; 
            position: relative; 
        }
        #results { 
            margin-top: 20px; 
            padding: 15px; 
            background-color: #f9f9f9; 
            border-radius: 8px; 
            border: 1px solid #ddd; 
        }
        #results p {
            margin: 5px 0; /* 讓結果段落更緊湊 */
        }
        .error-message { 
            color: red; 
            margin-top: 10px; 
        }
        header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap; /* 允許標題和按鈕換行 */
            margin-bottom: 20px;
        }
        header h1 {
            font-size: 1.8em; /* 調整手機標題大小 */
            margin: 0;
        }
        #lang-toggle { 
            font-size: 0.9em; /* 調整按鈕大小 */
            padding: 5px 10px; 
            background-color: #f0f0f0; 
            border: 1px solid #ccc; 
            cursor: pointer; 
            border-radius: 4px; 
            white-space: nowrap; /* 防止按鈕文字換行 */
        }
        /* 針對小螢幕進一步優化 */
        @media (max-width: 600px) {
            body {
                padding: 15px;
            }
            header {
                flex-direction: column; /* 垂直排列標題和按鈕 */
                align-items: flex-start; /* 左對齊 */
            }
            #lang-toggle {
                margin-top: 10px;
                align-self: flex-end; /* 將按鈕靠右 */
            }
            h1 {
                font-size: 1.5em;
            }
            .progress-label {
                font-size: 0.85em; /* 在小螢幕上進一步縮小文字 */
            }
        }
    </style>
</head>
<body>
    <header>
        <h1 id="title">Pokemon Go 衝等計算機</h1>
        <button id="lang-toggle">EN</button>
    </header>

    <label id="label-currentLevel">當前等級:</label>
    <input type="number" id="currentLevel" min="1" max="50" value="1">

    <label id="label-currentXP">目前 XP:</label>
    <input type="text" id="currentXP" min="0" value="0">

    <label id="label-targetLevel">目標等級:</label>
    <input type="number" id="targetLevel" min="1" max="50" value="50">

    <label id="label-startDate">起始日期:</label>
    <input type="date" id="startDate">

    <label id="label-endDate">目標日期:</label>
    <input type="date" id="endDate">

    <button id="calculate-btn" onclick="calculate()">計算</button>

    <div id="results">
        <h3 id="results-title">計算結果</h3>
        <div id="resultContent"></div>
    </div>

    <div class="progress-container">
        <div class="progress-label">
            <span id="currentLevelProgressTitle">目前等級進度</span>
            <span id="currentLevelProgressText">0%</span>
        </div>
        <div class="progress">
            <div id="currentLevelProgressBar" class="progress-bar"></div>
        </div>
    </div>
    
    <div class="progress-container">
        <div class="progress-label">
            <span id="overallProgressTitle">封頂進度 (至 50 級)</span>
            <span id="overallProgressText">0%</span>
        </div>
        <div class="progress">
            <div id="overallProgressBar" class="progress-bar"></div>
        </div>
    </div>

    <div id="errorMsg" class="error-message"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const xpTable = [
                0, 1000, 3000, 6000, 10000, 15000, 21000, 28000, 36000, 45000,
                55000, 65000, 75000, 85000, 100000, 120000, 140000, 160000, 185000, 210000,
                260000, 335000, 435000, 560000, 710000, 900000, 1100000, 1350000, 1650000, 2000000,
                2500000, 3000000, 3750000, 4750000, 6000000, 7500000, 9500000, 12000000, 15000000, 20000000,
                26000000, 33500000, 42500000, 53500000, 66500000, 82000000, 100000000, 121000000, 146000000, 176000000
            ];
            const totalExpForLevel50 = xpTable[49];

            const langData = {
                zh: {
                    title: "Pokemon Go 衝等計算機",
                    labelCurrentLevel: "當前等級:",
                    labelCurrentXP: "目前 XP:",
                    labelTargetLevel: "目標等級:",
                    labelStartDate: "起始日期:",
                    labelEndDate: "目標日期:",
                    calculateBtn: "計算",
                    resultsTitle: "計算結果",
                    progressCurrentLevel: "目前等級進度",
                    progressOverall: "封頂進度 (至 50 級)",
                    neededXP: "距離目標需要經驗值:",
                    daysLeft: "距離目標天數:",
                    dailyXP: "每天平均需要經驗值:",
                    dailyExcellent: "每天平均需要 Excellent 投擲:",
                    congrats: `恭喜你！你目前的經驗值已經足以達到或超過 {targetLevel} 級了！`,
                    errorLevel: "請輸入有效的等級 (1-50) 和經驗值。",
                    errorTarget: "目標等級必須大於當前等級。",
                    errorDates: "請選擇起始日期和目標日期。",
                    errorDateOrder: "目標日期不能早於起始日期。"
                },
                en: {
                    title: "Pokemon Go Leveling Calculator",
                    labelCurrentLevel: "Current Level:",
                    labelCurrentXP: "Current XP:",
                    labelTargetLevel: "Target Level:",
                    labelStartDate: "Start Date:",
                    labelEndDate: "End Date:",
                    calculateBtn: "Calculate",
                    resultsTitle: "Results",
                    progressCurrentLevel: "Current Level Progress",
                    progressOverall: "Progress to Lv. 50",
                    neededXP: "XP needed to goal:",
                    daysLeft: "Days left to goal:",
                    dailyXP: "Daily XP needed:",
                    dailyExcellent: "Daily Excellent throws needed:",
                    congrats: `Congratulations! Your current XP is enough to reach or exceed level {targetLevel}!`,
                    errorLevel: "Please enter a valid level (1-50) and XP.",
                    errorTarget: "Target level must be greater than current level.",
                    errorDates: "Please select a start date and an end date.",
                    errorDateOrder: "End date cannot be earlier than start date."
                }
            };

            let currentLang = 'zh';

            const updateLang = () => {
                const data = langData[currentLang];
                document.getElementById('title').textContent = data.title;
                document.getElementById('lang-toggle').textContent = currentLang === 'zh' ? 'EN' : '中';
                document.getElementById('label-currentLevel').textContent = data.labelCurrentLevel;
                document.getElementById('label-currentXP').textContent = data.labelCurrentXP;
                document.getElementById('label-targetLevel').textContent = data.labelTargetLevel;
                document.getElementById('label-startDate').textContent = data.labelStartDate;
                document.getElementById('label-endDate').textContent = data.labelEndDate;
                document.getElementById('calculate-btn').textContent = data.calculateBtn;
                document.getElementById('results-title').textContent = data.resultsTitle;
                
                // 重新設置進度條的 title 文字，讓語言更新正確
                document.getElementById('currentLevelProgressTitle').textContent = data.progressCurrentLevel;
                document.getElementById('overallProgressTitle').textContent = data.progressOverall;
                
                // 重新觸發計算以更新結果內容中的文字
                calculate();
            };

            document.getElementById('lang-toggle').addEventListener('click', () => {
                currentLang = currentLang === 'zh' ? 'en' : 'zh';
                updateLang();
            });

            document.getElementById('startDate').valueAsDate = new Date();
            // 確保目標日期是正確的 YYYY-MM-DD 格式
            const defaultEndDate = new Date(2025, 9, 14); // 月份從 0 開始，9 代表 10 月
            document.getElementById('endDate').value = defaultEndDate.toISOString().split('T')[0];


            const xpInput = document.getElementById('currentXP');
            xpInput.addEventListener('input', (e) => {
                let value = e.target.value.replace(/,/g, '');
                if (!isNaN(value) && value !== '') {
                    e.target.value = Number(value).toLocaleString();
                } else if (value === '') {
                    e.target.value = '';
                }
            });

            window.calculate = function() {
                const currentLevel = parseInt(document.getElementById('currentLevel').value);
                const currentXPValue = document.getElementById('currentXP').value.replace(/,/g, '');
                const currentXP = currentXPValue === '' ? 0 : parseInt(currentXPValue);
                const targetLevel = parseInt(document.getElementById('targetLevel').value);
                const startDate = new Date(document.getElementById('startDate').value);
                const endDate = new Date(document.getElementById('endDate').value);
                const errorMsg = document.getElementById('errorMsg');
                const resultsDiv = document.getElementById('resultContent');
                
                const currentLevelProgressTitle = document.getElementById('currentLevelProgressTitle');
                const overallProgressTitle = document.getElementById('overallProgressTitle');
                const currentLevelProgressBar = document.getElementById('currentLevelProgressBar');
                const overallProgressBar = document.getElementById('overallProgressBar');
                const currentLevelProgressText = document.getElementById('currentLevelProgressText');
                const overallProgressText = document.getElementById('overallProgressText');

                const lang = langData[currentLang];
                errorMsg.textContent = '';
                resultsDiv.innerHTML = '';

                if (isNaN(currentLevel) || isNaN(targetLevel) || currentLevel < 1 || targetLevel < 1 || currentLevel > 50 || targetLevel > 50) {
                    errorMsg.textContent = lang.errorLevel;
                    return;
                }

                if (targetLevel <= currentLevel) {
                    errorMsg.textContent = lang.errorTarget;
                    return;
                }
                
                if (!document.getElementById('startDate').value || !document.getElementById('endDate').value) {
                    errorMsg.textContent = lang.errorDates;
                    return;
                }

                const totalExpAtCurrentLevel = xpTable[currentLevel - 1];
                const totalExpToNextLevel = (currentLevel === 50) ? 0 : xpTable[currentLevel] - xpTable[currentLevel - 1];
                const totalExpToTargetLevel = xpTable[targetLevel - 1];
                const totalCurrentExp = totalExpAtCurrentLevel + currentXP;
                
                if (totalCurrentExp >= totalExpToTargetLevel) {
                    resultsDiv.innerHTML = lang.congrats.replace('{targetLevel}', targetLevel);
                    currentLevelProgressBar.style.width = '100%';
                    overallProgressBar.style.width = '100%';
                    currentLevelProgressText.textContent = '100%';
                    overallProgressText.textContent = '100%';
                    return;
                }

                const totalXPNeeded = totalExpToTargetLevel - totalCurrentExp;
                const timeDiff = endDate - startDate;
                const daysLeft = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));

                if (daysLeft < 0) {
                    errorMsg.textContent = lang.errorDateOrder;
                    return;
                }

                const dailyXP = daysLeft > 0 ? Math.ceil(totalXPNeeded / daysLeft) : totalXPNeeded;
                const dailyExcellentThrowsNeeded = Math.ceil(dailyXP / 2000);
                
                const currentLevelProgressPercent = (totalExpToNextLevel > 0) ? Math.min((currentXP / totalExpToNextLevel) * 100, 100) : 100;
                
                const overallProgressPercent = (totalCurrentExp / totalExpForLevel50) * 100;

                resultsDiv.innerHTML = `
                    <p><strong>${lang.neededXP}</strong> ${totalXPNeeded.toLocaleString()}</p>
                    <p><strong>${lang.daysLeft}</strong> ${daysLeft} ${currentLang === 'zh' ? '天' : 'days'}</p>
                    <p><strong>${lang.dailyXP}</strong> ${dailyXP.toLocaleString()}</p>
                    <p><strong>${lang.dailyExcellent}</strong> ${dailyExcellentThrowsNeeded.toLocaleString()} ${currentLang === 'zh' ? '次' : 'throws'}</p>
                `;
                
                // 更新進度條標題以反映當前語言和等級
                currentLevelProgressTitle.textContent = `${lang.progressCurrentLevel} (${currentLevel} → ${currentLevel + 1})`;
                overallProgressTitle.textContent = `${lang.progressOverall}`; // 已經包含 (至 50 級) 或 Lv. 50
                
                currentLevelProgressBar.style.width = `${currentLevelProgressPercent.toFixed(2)}%`;
                overallProgressBar.style.width = `${overallProgressPercent.toFixed(2)}%`;
                currentLevelProgressText.textContent = `${currentXP.toLocaleString()} / ${(totalExpToNextLevel).toLocaleString()} XP (${currentLevelProgressPercent.toFixed(2)}%)`;
                overallProgressText.textContent = `${totalCurrentExp.toLocaleString()} / ${totalExpForLevel50.toLocaleString()} XP (${overallProgressPercent.toFixed(2)}%)`;
            }
            updateLang(); // 初始化時呼叫以設定語言和初始計算
        });
    </script>
</body>
</html>
